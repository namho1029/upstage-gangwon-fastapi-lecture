name: Build & Version & Push Image (GHCR) + Deploy (K8s)

on:
  push:
    branches: [ deploy/version ]

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate version tag (pyproject + git)
        id: version
        run: |
          set -euo pipefail

          # pyproject.toml 에서 version 추출 (간단 버전)
          PYPROJECT_VERSION=$(grep '^version' pyproject.toml | cut -d '"' -f2)

          # git commit short hash
          GIT_SHA=$(git rev-parse --short=7 HEAD)

          VERSION_TAG="${PYPROJECT_VERSION}-${GIT_SHA}"

          echo "version_tag=${VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "Generated version: ${VERSION_TAG}"

      - name: Build & Push
        run: |
          set -euo pipefail

          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/gangwon-namho"
          VERSION_TAG="${{ steps.version.outputs.version_tag }}"

          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t "${IMAGE_NAME}:${VERSION_TAG}" \
            -t "${IMAGE_NAME}:latest" \
            --push .

      # 레포에 있는 매니페스트를 EC2로 복사 (EC2에 repo 없어도 됨)
      - name: Copy manifest to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "infra/k8s/application/04-backend.yaml"
          target: "/home/ubuntu/k8s-manifest"

      - name: Deploy on K8s
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            VERSION_TAG="${{ steps.version.outputs.version_tag }}"
            IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/gangwon-namho"
            IMAGE="${IMAGE_NAME}:${VERSION_TAG}"

            # scp-action은 target 아래에 source 경로를 그대로 만들기도 해서
            # 1) /home/ubuntu/k8s-manifest/infra/k8s/application/04-backend.yaml
            # 2) /home/ubuntu/k8s-manifest/04-backend.yaml
            # 두 케이스 모두 대응
            FILE1="/home/ubuntu/k8s-manifest/infra/k8s/application/04-backend.yaml"
            FILE2="/home/ubuntu/k8s-manifest/04-backend.yaml"

            if [ -f "$FILE1" ]; then
              FILE="$FILE1"
            elif [ -f "$FILE2" ]; then
              FILE="$FILE2"
            else
              echo "ERROR: manifest not found under /home/ubuntu/k8s-manifest"
              ls -R /home/ubuntu/k8s-manifest || true
              exit 1
            fi

            echo "Using manifest: $FILE"
            sed -i "s|^\(\s*image:\s*\).*|\1${IMAGE}|g" "$FILE"

            kubectl apply -f "$FILE"
            kubectl rollout status deployment/backend -n gangwon
            kubectl get pods -n gangwon
